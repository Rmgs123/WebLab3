<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Главная страница</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'home/home.css' %}">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body>
    <div class="container">
        <!-- Верхняя панель с именем пользователя и кнопкой выхода -->
        <header>
            <div class="profile-img">
                <img src="{{user.profile.image.url}}" alt="Profile image">
            </div>
            <div class="username-display">Добро пожаловать, {{user.username}}!</div>
            <div class="logout"><a href="{% url 'account_settings' %}">Настройки</a></div>
        </header>

        <!-- Боковая панель для контактов -->
        <aside class="contacts-list">
            <h2>Контакты</h2>
            <ul>
                {% for contact in user.profile.contacts.all %}
                <li id="contact-{{ contact.user.username }}">
                    <div class="info-contact">
                        <img src="{{contact.user.profile.image.url}}" alt="Profile image">
                        <a href="{% url 'home' %}?chat_with={{ contact.user.username }}">{{ contact.user.username }}</a>
                    </div>
                    <span class="notification-dot" style="display:none;">●</span>
                </li>
                {% empty %}
                <li>Нет контактов</li>
                {% endfor %}
            </ul>
            <form class="add-contact-form" method="post" action="{% url 'add_contact' %}">
                {% csrf_token %}
                <input type="text" name="contact_name" placeholder="Добавить контакт" required>
                <button type="submit">Добавить</button>
            </form>
        </aside>

        <!-- Основной блок для чата -->
        <main class="chat">
            <div class="chat-header">
                Чат с <span id="chat-user">{{ chat_user|default_if_none:"[Имя собеседника]" }}</span>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    {% if chat_user %}
                    {% for message in messages %}
                    <div class="message {% if message.sender == user %}from-user{% else %}from-contact{% endif %}" data-timestamp="{{ message.timestamp|date:'c' }}" data-id="{{ message.id }}">
                        {% if message.image %}
                        <img src="{{ message.image.url }}" width="200">
                        {% endif %}
                        {% if message.content %}
                        <p>{{ message.content }}</p>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p>Нет сообщений.</p>
                    {% endfor %}
                    {% else %}
                    <p>Выберите контакт для начала чата.</p>
                    {% endif %}
                </div>
                {% if chat_user %}
                <form class="send-message-form" id="send-message-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="receiver_name" value="{{ chat_user }}">
                    <input type="text" name="message" id="message-input" placeholder="Напишите сообщение..." autocomplete="off">
                    <input type="file" name="image" id="image-input" accept=".png, .jpg, .jpeg">
                    <button type="submit">Отправить</button>
                </form>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Подключаем jQuery и ваш JavaScript-код перед закрывающим тегом body -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function() {
            let offset = $('#chat-messages .message').length;
            const limit = 20;
            let lastMessageTime = 0; // Для ограничения скорости отправки сообщений

            function isUserAtBottom() {
                const chatMessages = $('#chat-messages')[0];
                return chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 250; // Порог 250 пикселей
            }

            function loadOldMessages() {
                console.log("Вызвана функция loadOldMessages");
                let $oldestMessage = $('#chat-messages .message').first();
                let oldestMessageTimestamp = $oldestMessage.attr('data-timestamp');
                let oldestMessageId = parseInt($oldestMessage.attr('data-id'), 10);

                if (!oldestMessageTimestamp) {
                    return;
                }

                $.ajax({
                    url: "{% url 'load_old_messages' chat_user=chat_user %}",
                    type: 'GET',
                    data: {
                        'before_timestamp': oldestMessageTimestamp,
                        'before_id': oldestMessageId,
                        'limit': limit
                    },
                    success: function(response) {
                        console.log("Получены старые сообщения:", response.messages);

                        const messages = response.messages;
                        if (messages.length > 0) {
                            let scrollHeightBefore = $('#chat-messages')[0].scrollHeight;
                            let scrollTopBefore = $('#chat-messages').scrollTop();

                            messages.forEach(function(message) {
                                if ($('#chat-messages .message[data-id="' + message.id + '"]').length === 0) {
                                    let senderClass = message.sender === '{{ user.username }}' ? 'from-user' : 'from-contact';
                                    let messageHtml = `<div class="message ${senderClass}" data-timestamp="${message.timestamp}" data-id="${message.id}">`;
                                    if (message.image_url) {
                                        messageHtml += `<img src="${message.image_url}" width="200">`;
                                    }
                                    if (message.content) {
                                        messageHtml += `<p>${message.content}</p>`;
                                    }
                                    messageHtml += `</div>`;

                                    $('#chat-messages').prepend(messageHtml);
                                }
                            });

                            let scrollHeightAfter = $('#chat-messages')[0].scrollHeight;
                            $('#chat-messages').scrollTop(scrollTopBefore + (scrollHeightAfter - scrollHeightBefore));
                        } else {
                            $('#chat-messages').off('scroll');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("Ошибка загрузки старых сообщений: ", error);
                    }
                });
            }

            $('#chat-messages').on('scroll', function() {
                if ($(this).scrollTop() === 0) {
                    console.log("Прокрутка достигла верха, подгружаем старые сообщения");
                    loadOldMessages();
                }
            });

            function scrollToBottom() {
                $('#chat-messages').animate({ scrollTop: $('#chat-messages')[0].scrollHeight }, 300);
            }

            scrollToBottom();

            $('#send-message-form').on('submit', function(event) {
                event.preventDefault();

                const now = Date.now();
                if (now - lastMessageTime < 1000) {
                    alert("Вы слишком часто отправляете сообщения. Пожалуйста, подождите немного.");
                    return;
                }

                lastMessageTime = now;

                const formData = new FormData(this);

                $.ajax({
                    url: "{% url 'send_message' %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            const messageContent = $('#message-input').val();
                            const imageInput = $('#image-input')[0].files[0];

                            let messageHtml = `<div class="message from-user" data-timestamp="${response.timestamp}" data-id="${response.id}">`;
                            if (imageInput) {
                                messageHtml += `<img src="${URL.createObjectURL(imageInput)}" width="200">`;
                            }
                            if (messageContent) {
                                messageHtml += `<p>${messageContent}</p>`;
                            }
                            messageHtml += `</div>`;

                            $('#chat-messages').append(messageHtml);

                            $('#message-input').val('');
                            $('#image-input').val('');

                            // Прокручиваем вниз после отправки сообщения
                            scrollToBottom();
                        } else {
                            alert(response.message || "Ошибка отправки сообщения.");
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("Ошибка отправки сообщения: ", error);
                    }
                });
            });

            function checkNewMessages() {
                $.ajax({
                    url: "{% url 'check_new_messages' %}",
                    type: 'GET',
                    success: function(response) {
                        $('.notification-dot').hide();
                        response.contacts_with_unread.forEach(function(contact) {
                            if (contact !== "{{ chat_user|escapejs }}") {
                                $(`#contact-${contact} .notification-dot`).show();
                            }
                        });
                        setTimeout(checkNewMessages, 1000);
                    },
                    error: function() {
                        setTimeout(checkNewMessages, 2000);
                    }
                });
            }

            function loadNewMessages() {
                let $latestMessage = $('#chat-messages .message').last();
                let latestMessageTimestamp = $latestMessage.attr('data-timestamp');
                let latestMessageId = parseInt($latestMessage.attr('data-id'), 10);

                if (!latestMessageTimestamp) {
                    latestMessageTimestamp = new Date().toISOString();
                    latestMessageId = 0;
                }

                $.ajax({
                    url: "{% url 'get_new_messages' chat_user=chat_user %}",
                    type: 'GET',
                    data: {
                        'after_timestamp': latestMessageTimestamp,
                        'after_id': latestMessageId
                    },
                    success: function(response) {
                        if (response.new_messages) {
                            const wasAtBottom = isUserAtBottom();

                            response.new_messages.forEach(function(message) {
                                if ($('#chat-messages .message[data-id="' + message.id + '"]').length === 0) {
                                    let senderClass = message.sender === '{{ user.username }}' ? 'from-user' : 'from-contact';
                                    let messageHtml = `<div class="message ${senderClass}" data-timestamp="${message.timestamp}" data-id="${message.id}">`;
                                    if (message.image_url) {
                                        messageHtml += `<img src="${message.image_url}" width="200">`;
                                    }
                                    if (message.content) {
                                        messageHtml += `<p>${message.content}</p>`;
                                    }
                                    messageHtml += `</div>`;
                                    $('#chat-messages').append(messageHtml);
                                }
                            });

                            // Прокручиваем вниз, только если пользователь был внизу чата
                            if (response.new_messages.length > 0 && wasAtBottom) {
                                scrollToBottom();
                            }
                        }
                        setTimeout(loadNewMessages, 500);
                    },
                    error: function(xhr, status, error) {
                        console.log("Ошибка загрузки новых сообщений: ", error);
                        setTimeout(loadNewMessages, 1000);
                    }
                });
            }

            function updateContacts() {
                $.ajax({
                    url: "{% url 'get_contacts' %}",
                    type: 'GET',
                    success: function(response) {
                        const contacts = response.contacts;
                        const $contactsList = $('.contacts-list ul');
                        $contactsList.empty(); // Очищаем текущий список контактов

                        contacts.forEach(function(contact) {
                            let contactHtml = `
                                <li id="contact-${contact.username}">
                                    <div class="info-contact">
                                        <img src="${contact.profile_image_url}" alt="Profile image">
                                        <a href="{% url 'home' %}?chat_with=${contact.username}">${contact.username}</a>
                                    </div>
                                    <span class="notification-dot" style="display:none;">●</span>
                                </li>
                            `;
                            $contactsList.append(contactHtml);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.log("Ошибка обновления списка контактов: ", error);
                    }
                });
            }

            // Запускаем обновление списка контактов каждые 5 секунд
            setInterval(updateContacts, 5000);

            checkNewMessages();
            loadNewMessages();
        });
    </script>
</body>
</html>
