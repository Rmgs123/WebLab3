<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Главная страница</title>
        {% load static %}
        <link rel="stylesheet" href="{% static 'home/home.css' %}">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    </head>
    <body>
    <div class="container">
        <!-- Верхняя панель с именем пользователя и кнопкой выхода -->
        <header>
            <div class="profile-img">
                <img src="{{user.profile.image.url}}" alt="Progile image">
            </div>
            <div class="username-display">Welcome, {{ user.username }}!</div>
            <div class="logout"><a href="{% url 'account_settings' %}">Settings</a></div>
        </header>

        <!-- Боковая панель для контактов -->
        <aside class="contacts-list">
            <h2>Contacts</h2>
            <ul>
                {% for contact in user.profile.contacts.all %}
                <li id="contact-{{ contact.user.username }}">
                    <div class="info-contact">
                        <img src="{{contact.user.profile.image.url}}" alt="Progile image">
                        <a href="{% url 'home' %}?chat_with={{ contact.user.username }}">{{ contact.user.username }}</a>

                    </div>
                    <span class="notification-dot" style="display:none;">●</span>
                </li>
                {% empty %}
                <li>No contacts</li>
                {% endfor %}
            </ul>
            <form class="add-contact-form" method="post" action="{% url 'add_contact' %}">
                {% csrf_token %}
                <input type="text" name="contact_name" placeholder="Add contact" required>
                <button type="submit">Add</button>
            </form>
        </aside>

        <!-- Основной блок для чата -->                   <!-- ИЗМЕНИЛ ПОЛНОСТЬЮ ТУТ ВЕСЬ БЛОК -->
        <main class="chat">
            <div class="chat-header">
                Chat with <span id="chat-user">{{ chat_user|default_if_none:"[username]" }}</span>
            </div>
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    {% if chat_user %}
                    {% for message in messages %}
                    <div class="message {% if message.sender == user %}from-user{% else %}from-contact{% endif %}">
                        {% if message.image %}
                        <img src="{{ message.image.url }}" width="200">
                        {% endif %}
                        {% if message.content %}
                        <p>{{ message.content }}</p>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p>No messages.</p>
                    {% endfor %}
                    {% else %}
                    <p>Select a contact to start a chat.</p>
                    {% endif %}
                </div>
                {% if chat_user %}
                <form class="send-message-form" id="send-message-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="receiver_name" value="{{ chat_user }}">
                    <input type="text" name="message" id="message-input" placeholder="Напишите сообщение..." autocomplete="off">
                    <input type="file" name="image" id="image-input" accept=".png, .jpg, .jpeg">
                    <button type="submit">Send</button>
                </form>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Подключаем jQuery и ваш JavaScript-код перед закрывающим тегом body -->          <!-- ПОМЕНЯЛ ТУТ ВСЕ СКРИПТЫ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function() {
            let offset = $('#chat-messages .message').length;  // Инициализируем offset количеством загруженных сообщений
            const limit = 20;  // Количество сообщений для подгрузки

            // Функция для загрузки старых сообщений
            function loadOldMessages() {
                $.ajax({
                    url: "{% url 'load_old_messages' chat_user=chat_user %}",
                    type: 'GET',
                    data: {
                        'offset': offset,
                        'limit': limit
                    },
                    success: function(response) {
                        const messages = response.messages;
                        if (messages.length > 0) {
                            // Сохраняем текущую позицию прокрутки
                            let scrollHeightBefore = $('#chat-messages')[0].scrollHeight;
                            let scrollTopBefore = $('#chat-messages').scrollTop();

                            // Добавляем сообщения в начало
                            messages.forEach(function(message) {
                                let messageHtml = `<div class="message ${message.sender === '{{ user.username }}' ? 'from-user' : 'from-contact'}">`;
                                if (message.image_url) {
                                    messageHtml += `<img src="${message.image_url}" width="200">`;
                                }
                                if (message.content) {
                                    messageHtml += `<p>${message.content}</p>`;
                                }
                                messageHtml += `</div>`;
                                $('#chat-messages').prepend(messageHtml);
                            });

                            // Обновляем offset
                            offset += messages.length;

                            // Восстанавливаем позицию прокрутки
                            let scrollHeightAfter = $('#chat-messages')[0].scrollHeight;
                            $('#chat-messages').scrollTop(scrollTopBefore + (scrollHeightAfter - scrollHeightBefore));
                        } else {
                            // Больше нет сообщений для загрузки
                            $('#chat-messages').off('scroll');
                        }
                    }
                });
            }

            // Обработчик прокрутки вверх для подгрузки старых сообщений
            $('#chat-messages').on('scroll', function() {
                if ($(this).scrollTop() === 0) {
                    loadOldMessages();
                }
            });

            // Функция для плавной прокрутки вниз
            function scrollToBottom() {
                $('#chat-messages').animate({ scrollTop: $('#chat-messages')[0].scrollHeight }, 300);
            }

            // Первоначальная прокрутка вниз при загрузке страницы
            scrollToBottom();

            // Инициализация смещения при загрузке страницы
            //offset = $('#chat-messages .message').length;

            // AJAX отправка сообщений, включая изображение
            $('#send-message-form').on('submit', function(event) {
                event.preventDefault();

                const formData = new FormData(this);

                $.ajax({
                    url: "{% url 'send_message' %}",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            const messageContent = $('#message-input').val();
                            const imageInput = $('#image-input')[0].files[0];

                            let messageHtml = `<div class="message from-user">`;
                            if (imageInput) {
                                messageHtml += `<img src="${URL.createObjectURL(imageInput)}" width="200">`;
                            }
                            if (messageContent) {
                                messageHtml += `<p>${messageContent}</p>`;
                            }
                            messageHtml += `</div>`;

                            $('#chat-messages').append(messageHtml);

                            $('#message-input').val('');
                            $('#image-input').val('');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.log("Ошибка отправки сообщения: ", error);
                    }
                });
            });

            // Функция для проверки новых сообщений с использованием setTimeout
            function checkNewMessages() {
                $.ajax({
                    url: "{% url 'check_new_messages' %}",
                    type: 'GET',
                    success: function(response) {
                        $('.notification-dot').hide();  // Скрываем все точки уведомлений
                        response.contacts_with_unread.forEach(function(contact) {
                            // Если чат с этим контактом не открыт, показываем уведомление
                            if (contact !== "{{ chat_user|escapejs }}") {
                                $(`#contact-${contact} .notification-dot`).show();
                            }
                        });
                        // Планируем следующий вызов через 1 секунду
                        setTimeout(checkNewMessages, 1000);
                    },
                    error: function() {
                        // В случае ошибки также планируем следующий вызов, но можем увеличить интервал
                        setTimeout(checkNewMessages, 2000);  // Делаем 2 секунды, чтобы снизить нагрузку при ошибках
                    }
                });
            }

            // Функция для загрузки новых сообщений с использованием setTimeout
            function loadNewMessages() {
                $.ajax({
                    url: "{% url 'get_new_messages' chat_user=chat_user %}",
                    type: 'GET',
                    success: function(response) {
                        response.new_messages.forEach(function(message) {
                            // Создаем HTML для сообщения
                            let messageHtml = `<div class="message from-contact">`;
                            if (message.image_url) {
                                messageHtml += `<img src="${message.image_url}" width="200">`;
                            }
                            if (message.content) {
                                messageHtml += `<p>${message.content}</p>`;
                            }
                            messageHtml += `</div>`;

                            // Добавляем сообщение в чат
                            $('#chat-messages').append(messageHtml);
                        });
                        // Планируем следующий запрос через 0.5 секунд
                        setTimeout(loadNewMessages, 500);
                    },
                    error: function() {
                        // В случае ошибки увеличиваем интервал, чтобы избежать повторных сбоев
                        setTimeout(loadNewMessages, 1000);  // Увеличиваем интервал до 1 секунд на случай ошибки
                    }
                });
            }

            // Запускаем функции с setTimeout вместо setInterval
            checkNewMessages();
            loadNewMessages();
        });
    </script>
</body>
</html>